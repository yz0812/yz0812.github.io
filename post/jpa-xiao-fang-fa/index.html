<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
<title>JPA 小方法 - yz</title>
<meta name="description" content="少年拥有了时间,时间带走了年少" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<link type="text/css" rel="stylesheet" href="https://yz0812.github.io/styles/main.css" media="screen" />
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" />
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" />
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css" integrity="sha512-FwY1WVsm4UQgrOXt6kaQ53w83cOHa8fSvjFn/BvVOCYVPmkSR39k/xnU+8hht3zW6JL1TBd4C/aVQIAV58Cg6A==" crossorigin="anonymous" /> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/atom-one-dark.min.css" integrity="sha512-Jlyabam8ztU2kOGN19fSzv1Go9nt9A43UA6vhmL1MPsQMeoPZd+p7pbmegAtyl8kulna0Cqwb7Pgj4adGTLCXA==" crossorigin="anonymous" />
<script type="text/javascript" src="https://yz0812.github.io/media/scripts/jquery.js"></script>
<!-- <script type="text/javascript" src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js" integrity="sha512-tHQeqtcNWlZtEh8As/4MmZ5qpy0wj04svWFK7MIzLmUVIzaHXS8eod9OmHxyBL1UET5Rchvw7Ih4ZDv5JojZww==" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-7JNCPNX91Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-7JNCPNX91Z');
</script>


<script>
  hljs.initHighlightingOnLoad();
</script>

</head>

<body>
  <div class="layout">
    <div class="layout-header">

	<div class="layout-header-main">
		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">

					<div class="navbar">

						<div class="logo">
							<a href="https://yz0812.github.io">
								<img class="logo" src="https://yz0812.github.io/media/images/site_avatar.png?v=1770995982259"
									alt="">
							</a>
						</div>

						<div class="menu d-md-inline-block d-none">
							<ul class="layout-navigation-list">
								
								<li class="layout-navigation-item"><a title="归档"
										href="/archives">归档</a>
								</li>
								
								<li class="layout-navigation-item"><a title="标签"
										href="/tags">标签</a>
								</li>
								
								<li class="layout-navigation-item"><a title="关于"
										href="/post/about">关于</a>
								</li>
								
							</ul>
						</div>

						

						<div class="nav d-md-none d-inline-block">
							<div class="trigger">
								<i class="fa fa-bars layout-btn-toggle" aria-hidden="true"></i>
							</div>
						</div>

					</div>

				</div>
			</div>




		</div>
	</div>

</div>
    <div class="layout-collapse d-md-none">
	<div class="layout-collapse-main">
		<ul class="layout-collapse-list">
			
			<li class="layout-collapse-item"><a title="归档" href="/archives">归档</a></li>
			
			<li class="layout-collapse-item"><a title="标签" href="/tags">标签</a></li>
			
			<li class="layout-collapse-item"><a title="关于" href="/post/about">关于</a></li>
			

		</ul>
	</div>
</div>

    <div class="layout-content">
      <div class="layout-content-main">
        <div class="container">
          <div class="row justify-content-lg-center">
            <div class="col-12 col-lg-9">
              <div class="layout-post">
                <div class="layout-post-body">
                  <div class="row">

                    <div class="col-12 col-lg-10">
                      <div class="layout-post-main m-right m-md-right">
                        <div class="layout-post-header">
                          <h1 class="layout-post-title">JPA 小方法</h1>
                          <div class="layout-post-meta">
                            <div class="item">
                               <a href="https://yz0812.github.io/tag/EXPhuDLUo/" class="post--keyword"
                                data-title="教程" data-type="post_tag" data-term-id="39">教程</a>
                               <a href="https://yz0812.github.io/tag/Ksbd-vR2dH/" class="post--keyword"
                                data-title="spring" data-type="post_tag" data-term-id="39">spring</a>
                              
                            </div>
                            <div class="item">
                              <span>2024-04-26</span>
                            </div>
                          </div>
                        </div>
                        <div class="layout-post-content">
                          <div class="layout-post-item">
                            
                            <p class="with-img"><img src="https://fastly.jsdelivr.net/gh/yz0812/mypic@master/img/76.jpg"
                                class="attachment-full size-full wp-post-image" alt="JPA 小方法" /></p>
                            
                            <h2 id="1生命周期注解">1.生命周期注解</h2>
<p>JPA 生命周期事件注解的执行顺序如下：</p>
<ol>
<li><code>@PrePersist</code>: 在实体对象被持久化到数据库之前调用。</li>
<li><code>@PostPersist</code>: 在实体对象被持久化到数据库之后调用。</li>
<li><code>@PreUpdate</code>: 在实体对象更新到数据库之前调用。</li>
<li><code>@PostUpdate</code>: 在实体对象更新到数据库之后调用。</li>
<li><code>@PreRemove</code>: 在实体对象从数据库中移除之前调用。</li>
<li><code>@PostRemove</code>: 在实体对象从数据库中移除之后调用。</li>
<li><code>@PostLoad</code>: 在实体对象从数据库加载到内存后调用。</li>
</ol>
<h3 id="1-entitylisteners">1. @EntityListeners</h3>
<blockquote>
<p><strong><code>@EntityListeners</code> 是 Java Persistence API (JPA) 中的一个注解，用于将实体监听器（Entity Listeners）与特定的实体类关联起来。实体监听器是一种特殊的类，用于在实体对象的生命周期事件发生时执行相应的操作。<code>@EntityListeners</code> 注解的作用是将这些监听器与实体类进行绑定，以便在实体类触发相应事件时调用监听器中定义的方法。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
@EntityListeners(EmployeeListener.class)
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;
}

public class EmployeeListener {
    @PrePersist
    public void prePersist(Employee employee) {
        // 在实体对象被持久化到数据库之前调用
        System.out.println(&quot;Employee prePersist: &quot; + employee.getName());
    }

    @PostPersist
    public void postPersist(Employee employee) {
        // 在实体对象被持久化到数据库之后调用
        System.out.println(&quot;Employee postPersist: &quot; + employee.getName());
    }

 
}
</code></pre>
<h3 id="2-prepersist">2. @PrePersist</h3>
<blockquote>
<p><strong><code>@PrePersist</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象被持久化到数据库之前要执行的方法。当执行持久化操作时，例如调用 <code>EntityManager</code> 的 <code>persist</code> 方法保存实体对象时，被标记了 <code>@PrePersist</code> 注解的方法将在实体对象被持久化之前被调用。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PrePersist
    public void prePersist() {
        // 在实体对象被持久化到数据库之前调用
        System.out.println(&quot;PrePersist: &quot; + name);
        // 可在这里执行其他逻辑操作
    }
}
</code></pre>
<h3 id="3-postpersist">3. @PostPersist</h3>
<blockquote>
<p><strong><code>@PostPersist</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象被持久化到数据库之后要执行的方法。当执行持久化操作时，例如调用 <code>EntityManager</code> 的 <code>persist</code> 方法保存实体对象后，被标记了 <code>@PostPersist</code> 注解的方法将在实体对象被持久化之后被调用。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PostPersist
    public void postPersist() {
        // 在实体对象被持久化到数据库之后调用
        System.out.println(&quot;PostPersist: &quot; + name);
        // 可在这里执行其他逻辑操作
    }
}
</code></pre>
<h3 id="4-preupdate">4. @PreUpdate</h3>
<blockquote>
<p><strong><code>@PreUpdate</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象更新到数据库之前要执行的方法。当执行更新操作时，例如调用 <code>EntityManager</code> 的 <code>merge</code> 方法更新实体对象时，被标记了 <code>@PreUpdate</code> 注解的方法将在实体对象更新之前被调用</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PreUpdate
    public void preUpdate() {
        // 在实体对象更新到数据库之前调用
        System.out.println(&quot;PreUpdate: &quot; + name);
        // 可在这里执行其他逻辑操作
    }
}
</code></pre>
<h3 id="5-postupdate">5. @PostUpdate</h3>
<blockquote>
<p><strong><code>@PostUpdate</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象更新到数据库之后要执行的方法。当执行更新操作时，例如调用 <code>EntityManager</code> 的 <code>merge</code> 方法更新实体对象后，被标记了 <code>@PostUpdate</code> 注解的方法将在实体对象更新之后被调用</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PostUpdate
    public void postUpdate() {
        // 在实体对象更新到数据库之后调用
        System.out.println(&quot;PostUpdate: &quot; + name);
        // 可在这里执行其他逻辑操作
    }
}
</code></pre>
<h3 id="6-preremove">6. @PreRemove</h3>
<blockquote>
<p><strong><code>@PreRemove</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象从数据库中移除之前要执行的方法。当执行删除操作时，例如调用 <code>EntityManager</code> 的 <code>remove</code> 方法删除实体对象时，被标记了 <code>@PreRemove</code> 注解的方法将在实体对象被移除之前被调用。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PreRemove
    public void preRemove() {
        // 在实体对象从数据库中移除之前调用
        System.out.println(&quot;PreRemove: &quot; + name);
        // 可在这里执行其他逻辑操作
    }
}
</code></pre>
<h3 id="7-postremove">7. @PostRemove</h3>
<blockquote>
<p>** <code>@PostRemove</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象从数据库中移除之后要执行的方法。当执行删除操作时，例如调用 <code>EntityManager</code> 的 <code>remove</code> 方法删除实体对象后，被标记了 <code>@PostRemove</code> 注解的方法将在实体对象被移除之后被调用。**</p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PostRemove
    public void postRemove() {
        // 在实体对象从数据库中移除之后调用
        System.out.println(&quot;PostRemove: &quot; + name);
        // 可在这里执行其他逻辑操作
    }

}
</code></pre>
<h3 id="8-postload">8. @PostLoad</h3>
<blockquote>
<p><strong><code>@PostLoad</code> 是 Java Persistence API (JPA) 的一个生命周期事件注解，用于指定在实体对象从数据库加载到内存后要执行的方法。当从数据库中检索实体对象时，被标记了 <code>@PostLoad</code> 注解的方法将在实体对象加载到内存后被调用。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;

    @PostLoad
    public void postLoad() {
        // 在实体对象从数据库加载到内存后调用
        System.out.println(&quot;PostLoad: &quot; + name);
        // 可在这里执行其他逻辑操作
    }

}
</code></pre>
<h3 id="9-dynamicupdate">9. @DynamicUpdate</h3>
<blockquote>
<p><strong><code>@DynamicUpdate</code> 是 Hibernate 框架提供的一个注解，用于指定只更新发生变化的字段到数据库，而忽略未发生变化的字段。它可以应用于实体类上，表示在执行更新操作时，只更新被修改的字段，而不更新所有字段。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
@Table(name = &quot;employees&quot;)
@DynamicUpdate
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;
    private double salary;
}
</code></pre>
<p>执行数据操作</p>
<pre><code class="language-java">public class Main {
    public static void main(String[] args) {
        EntityManagerFactory emf = Persistence.createEntityManagerFactory(&quot;myPersistenceUnit&quot;);
        EntityManager em = emf.createEntityManager();

        // 创建一个新的 Employee 对象
        Employee employee = new Employee();
        employee.setName(&quot;John&quot;);
        employee.setDepartment(&quot;IT&quot;);
        employee.setSalary(5000.0);

        // 将对象保存到数据库
        em.getTransaction().begin();
        em.persist(employee);
        em.getTransaction().commit();

        // 更新 Employee 对象的部门和薪水字段
        em.getTransaction().begin();
        employee.setDepartment(&quot;HR&quot;);
        employee.setSalary(6000.0);
        em.getTransaction().commit();

        em.close();
        emf.close();
    }
}
</code></pre>
<p>使用 <code>@DynamicUpdate</code> 注解时生成的更新语句（只更新发生变化的字段）：</p>
<pre><code class="language-sql">UPDATE employees SET department = 'HR', salary = 6000.0 WHERE id = 1;
</code></pre>
<p>未使用 <code>@DynamicUpdate</code> 注解时生成的更新语句（更新所有字段）：</p>
<pre><code class="language-sql">UPDATE employees SET name = 'John', department = 'HR', salary = 6000.0 WHERE id = 1;
</code></pre>
<h3 id="10-dynamicinsert">10. @DynamicInsert</h3>
<blockquote>
<p><strong><code>@DynamicInsert</code> 是 Hibernate 框架提供的一个注解，用于指定在执行插入操作时，只插入非空字段到数据库，而忽略空值字段。它可以应用于实体类上，表示在执行插入操作时，只插入非空字段，而不插入空值字段。</strong></p>
</blockquote>
<pre><code class="language-java">import javax.persistence.*;

@Entity
@Table(name = &quot;employees&quot;)
@DynamicInsert
public class Employee {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String department;
    private double salary;

}
</code></pre>
<p>执行数据操作</p>
<pre><code class="language-java">public class Main {
    public static void main(String[] args) {
        EntityManagerFactory emf = Persistence.createEntityManagerFactory(&quot;myPersistenceUnit&quot;);
        EntityManager em = emf.createEntityManager();

        // 创建一个新的 Employee 对象
        Employee employee = new Employee();
        employee.setName(&quot;John&quot;);
        employee.setDepartment(&quot;IT&quot;);

        // 将对象保存到数据库
        em.getTransaction().begin();
        em.persist(employee);
        em.getTransaction().commit();

        em.close();
        emf.close();
    }
}
</code></pre>
<p>使用 <code>@DynamicInsert</code> 注解时生成的更新语句（只插入非空字段）：</p>
<pre><code class="language-sql">INSERT INTO employees (name, department) VALUES ('John', 'IT');
</code></pre>
<p>未使用 <code>@DynamicInsert</code> 注解时生成的更新语句（插入所有字段）：</p>
<pre><code class="language-sql">INSERT INTO employees (id, name, department, salary) VALUES (1, 'John', 'IT', 5000.0);
</code></pre>
<h2 id="2-projections投影">2. Projections（投影）</h2>
<blockquote>
<p><strong><code>Projections</code> 是一种功能，用于选择实体中的特定字段，以创建自定义的投影对象。投影对象是一个接口或类，仅包含您所选择的字段，而不是整个实体的所有字段。</strong></p>
<p><strong>通过使用投影，您可以在查询结果中返回仅包含所需字段的对象，而不是完整的实体对象。这有助于减少数据传输量和内存消耗，提高性能，并使查询结果更加精确和专注。</strong></p>
</blockquote>
<h3 id="接口投影interface-projections">接口投影（Interface Projections）</h3>
<p><strong>接口投影（Interface Projections）：使用接口来定义投影对象，并在接口中声明所需的字段访问方法。Spring Data JPA 将根据投影接口的定义来映射查询结果，并返回仅包含所需字段的投影对象。</strong></p>
<pre><code class="language-java">public interface EmployeeProjection {
    String getName();
    String getDepartment();
}

List&lt;EmployeeProjection&gt; findByDepartment(String department);
</code></pre>
<h3 id="closed-projections">（Closed Projections）</h3>
<p><strong>使用自定义的类来定义投影对象，并在类中声明所需的字段和构造方法。通过使用 <code>Projections.constructor</code> 方法，您可以将查询结果映射到自定义的投影类，并选择所需的字段。</strong></p>
<pre><code class="language-java">public class EmployeeProjection {
    private String name;
    private String department;

    public EmployeeProjection(String name, String department) {
        this.name = name;
        this.department = department;
    }
}

List&lt;EmployeeProjection&gt; findByDepartment(String department);
</code></pre>
<h3 id="动态投影-dynamic-projections">动态投影 (Dynamic Projections)</h3>
<p><strong>您可以通过动态投影实现在运行时选择不同字段的能力。动态投影允许您根据查询需求在运行时选择要返回的字段，而不是在编译时固定选择字段。</strong></p>
<pre><code class="language-java">public interface PersonRepository extends Repository&lt;Person, Long&gt; {
    // ...

    &lt;T&gt; T findByLastName(String lastName, Class&lt;T&gt; type);
}


Person person = personRepository.findByLastName(&quot;Doe&quot;, Person.class);
PersonView personView = personRepository.findByLastName(&quot;Doe&quot;, PersonView.class);
PersonDto personDto = personRepository.findByLastName(&quot;Doe&quot;, PersonDto.class);
</code></pre>
<h3 id="开放式投影open-projections">开放式投影（open projections）</h3>
<p><strong>开放式投影。 这些投影使我们能够定义具有不匹配名称和在运行时计算的返回值的接口方法。</strong></p>
<pre><code class="language-java">public interface PersonView {
    // ...

    @Value(&quot;#{target.firstName + ' ' + target.lastName}&quot;)
    String getFullName();
}

  PersonView findByLastName(String lastName);
</code></pre>
<h2 id="3-规范specification">3. 规范（Specification）</h2>
<h3 id="基本使用">基本使用</h3>
<p><strong>使用 Spring Data JPA 进行复杂查询时，可以使用 Specification（规范）来构建动态查询条件。Specification 可以帮助您以一种类型安全的方式根据运行时条件动态构建查询。</strong></p>
<pre><code class="language-java">import org.springframework.data.jpa.domain.Specification;

public class EmployeeSpecifications {
    public static Specification&lt;Employee&gt; hasName(String name) {
        return (root, query, criteriaBuilder) -&gt; {
            if (name != null) {
                return criteriaBuilder.equal(root.get(&quot;name&quot;), name);
            }
            return null;
        };
    }

    public static Specification&lt;Employee&gt; hasAgeGreaterThan(int age) {
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.greaterThan(root.get(&quot;age&quot;), age);
    }

    public static Specification&lt;Employee&gt; hasDepartment(String department) {
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(&quot;department&quot;), department);
    }

    // 添加更多的 Specification 方法，以满足您的查询需求
}
</code></pre>
<p>Service</p>
<pre><code class="language-java">import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@Transactional
public class EmployeeService {
    private final EmployeeRepository employeeRepository;

    public EmployeeService(EmployeeRepository employeeRepository) {
        this.employeeRepository = employeeRepository;
    }

    public List&lt;Employee&gt; findEmployees(String name, int age, String department) {
        Specification&lt;Employee&gt; spec = Specification.where(EmployeeSpecifications.hasName(name))
                .and(EmployeeSpecifications.hasAgeGreaterThan(age))
                .and(EmployeeSpecifications.hasDepartment(department));

        return employeeRepository.findAll(spec);
    }
}
</code></pre>
<p>Repository</p>
<pre><code class="language-java">import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;

@Repository
public interface EmployeeRepository extends JpaRepository&lt;Employee, Long&gt;, JpaSpecificationExecutor&lt;Employee&gt; {
}
</code></pre>
<p>复杂一点的servier</p>
<pre><code class="language-java">    @Override
    public Page&lt;EsAlarm&gt; page(EsPageRspVO vo) {
        Assert.notNull(vo.getProjectId(), ResultCode.NO_PROJECT_ID.getMessage());
        //条件定义
        Specification&lt;EsAlarm&gt; specification = (root, query, cb) -&gt; {
            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();


            Predicate deletedPredicate = cb.equal(root.get(EsAlarm.Fields.deleted), Deleted.UN_DELETED.getCode());
            predicates.add(deletedPredicate);

            Predicate projectPredicate = cb.equal(root.get(EsAlarm.Fields.projectId), vo.getProjectId());
            predicates.add(projectPredicate);

            if (vo.getProcessingStatus() != null) {
                Predicate predicate = cb.equal(root.get(EsAlarm.Fields.processingStatus), vo.getProcessingStatus());
                predicates.add(predicate);
            }

            if (StrUtil.isNotBlank(vo.getDeviceKeywords())) {
                Predicate predicate = cb.or(
                        cb.like(root.get(EsAlarm.Fields.deviceNo).as(String.class), StringConstant.likeString(vo.getDevice())),
                        cb.like(root.get(EsAlarm.Fields.deviceName).as(String.class), StringConstant.likeString(vo.getDevice()))
                );
                predicates.add(predicate);
            }

            return cb.and(predicates.toArray(new Predicate[0]));

        };
        Pageable pageable = PageRequest.of(vo.getPageNo() - 1, vo.getPageSize(), vo.getSortOption());
        //查询
        return esAlarmRepository.findAll(specification, pageable);
    }
</code></pre>
<h3 id="工具类">工具类</h3>
<p>基础工具类</p>
<pre><code class="language-java">
import cn.hutool.core.collection.CollUtil;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.domain.Specification;

import javax.persistence.criteria.*;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/**
 *
 * @author yz
 * @date 2024/03/15
 */

public class JpaSpecification&lt;T&gt; {

    private final List&lt;Specification&lt;T&gt;&gt; specifications;
    private Sort sort;

    public JpaSpecification() {
        specifications = new ArrayList&lt;&gt;();
    }

    public static &lt;T&gt; JpaSpecification&lt;T&gt; getInstance() {
        return new JpaSpecification&lt;&gt;();
    }

    public JpaSpecification&lt;T&gt; addSpecification(Specification&lt;T&gt; specification) {
        if (specification != null) {
            specifications.add(specification);
        }

        return this;
    }

    public JpaSpecification&lt;T&gt; withSort(Sort sort) {
        this.sort = sort;
        return this;
    }


    public Specification&lt;T&gt; build() {
        return (Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder criteriaBuilder) -&gt; {
            Predicate[] predicates = specifications.stream()
                    .map(spec -&gt; spec.toPredicate(root, query, criteriaBuilder))
                    .toArray(Predicate[]::new);

            query.where(predicates);

            if (sort != null) {
                query.orderBy(sort.stream()
                        .map(order -&gt; {
                            String property = order.getProperty();
                            Expression&lt;String&gt; orderExpr = root.get(property);
                            if (order.isIgnoreCase()) {
                                orderExpr = criteriaBuilder.lower(orderExpr);
                            }
                            return order.isAscending() ? criteriaBuilder.asc(orderExpr) : criteriaBuilder.desc(orderExpr);
                        })
                        .toArray(javax.persistence.criteria.Order[]::new));
            }

            return criteriaBuilder.and(predicates);
        };
    }

    public static &lt;T&gt; Specification&lt;T&gt; hasCreateTime(List&lt;Date&gt; queryTime) {
        if (CollUtil.isEmpty(queryTime)) {
            return null;
        }
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.between(root.get(&quot;createTime&quot;), queryTime.get(0), queryTime.get(1));
    }


    public static &lt;T&gt; Specification&lt;T&gt; hasDelete() {
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(&quot;deleted&quot;), 0);
    }

    public static &lt;T&gt; Specification&lt;T&gt; hasDeviceId(Integer deviceId) {
        if (deviceId == null) {
            return null;
        }
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(&quot;deviceId&quot;), deviceId);
    }

    public static &lt;T&gt; Specification&lt;T&gt; hasProjectId(Integer projectId) {
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(&quot;projectId&quot;), projectId);
    }
}
</code></pre>
<p>模块通用工具类</p>
<pre><code class="language-java">
public class ElevatorSpecification&lt;T&gt; {

    private final JpaSpecification&lt;T&gt; jpaSpecifications;


    public ElevatorSpecification() {
        jpaSpecifications = new JpaSpecification&lt;&gt;();
    }

    public static &lt;T&gt; ElevatorSpecification&lt;T&gt; getInstance() {
        return new ElevatorSpecification&lt;&gt;();
    }

    public static Specification&lt;AirConditionerRecord&gt; hasAirOperationType(String code) {
        if (StrUtil.isNotBlank(code)) {
            return null;
        }
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(AirConditionerRecord.Fields.operationType), code);
    }

    public ElevatorSpecification&lt;T&gt; withSort(Sort sort) {
        jpaSpecifications.withSort(sort);
        return this;
    }

    public ElevatorSpecification&lt;T&gt; addSpecification(Specification&lt;T&gt; specification) {
        jpaSpecifications.addSpecification(specification);
        return this;
    }

    public Specification&lt;T&gt; build() {
        return jpaSpecifications.build();
    }

    public static &lt;T&gt; Specification&lt;T&gt; hasAirStatus(Integer value) {
        return (root, query, criteriaBuilder) -&gt; criteriaBuilder.equal(root.get(AirConditionerRecord.Fields.status), value);
    }


}

</code></pre>
<p>使用方法</p>
<pre><code class="language-java">    default Optional&lt;AirConditionerRecord&gt; findLastSwitchRecord(Integer deviceId, Integer value, Integer projectId) {
        Specification&lt;AirConditionerRecord&gt; spec = ElevatorSpecification.&lt;AirConditionerRecord&gt;getInstance()
                .addSpecification(JpaSpecification.hasDelete())
                .addSpecification(JpaSpecification.hasProjectId(projectId))
                .addSpecification(JpaSpecification.hasDeviceId(deviceId))
                .addSpecification(ElevatorSpecification.hasAirOperationType(AirConditionerOperationTypeEnums.SWITCH.code))
                .addSpecification(ElevatorSpecification.hasAirStatus(value))
                .withSort(Sort.by(Sort.Direction.DESC, AirConditionerRecord.Fields.id))
                .build();
        return findOne(spec);
    }

</code></pre>

                          </div>
                        </div>
                        <div class="layout-post-social">
                          <div class="item reader">
                            <div id="/post/jpa-xiao-fang-fa/" class="leancloud-visitors view"
                              data-flag-title="JPA 小方法">
                              <span class="post-meta-item-text">阅读 </span>
                              <span class="leancloud-visitors-count"></span>
                            </div>
                          </div>
                        </div>

                        <div class="layout-post-navigation">
                          <div class="navigation-list">
                            
                            <div class="post-card row">
                              
                              <div class="card-content col-8 col-md-9">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://yz0812.github.io/post/guava-chang-yong-gong-ju-lei/" class="title">
                                      <h4>guava 常用工具类</h4>
                                    </a>
                                  </div>
                                  <div class="inner d-none d-sm-block">
                                    <div class="abstract">
                                      
                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>上一篇</span></div>
                                  <div class="item">2024-08-02</div>
                                </div>
                              </div>
                              <div class="card-thumb col-4 col-md-3">
                                <div class="thumb">
                                  <a href="https://yz0812.github.io/post/guava-chang-yong-gong-ju-lei/"
                                    style="background-image: url('https://fastly.jsdelivr.net/gh/yz0812/mypic@master/img/77.jpg');"></a>
                                </div>
                              </div>
                              
                            </div>

                            <div class="post-card row">
                              
                              <div class="card-content col-8 col-md-9">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://yz0812.github.io/post/oh-my-zsh-an-zhuang/" class="title">
                                      <h4> oh-my-zsh 安装</h4>
                                    </a>
                                  </div>
                                  <div class="inner d-none d-sm-block">
                                    <div class="abstract">
                                      
                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>下一篇</span></div>
                                  <div class="item">2023-09-20</div>
                                </div>
                              </div>
                              <div class="card-thumb col-4 col-md-3">
                                <div class="thumb">
                                  <a href="https://yz0812.github.io/post/oh-my-zsh-an-zhuang/"
                                    style="background-image: url('https://fastly.jsdelivr.net/gh/yz0812/mypic@master/img/75.jpg');"></a>
                                </div>
                              </div>
                              
                            </div>

                            
                          </div>
                        </div>

                        <div class="layout-comments" id="comments">
                          
                            
                        </div>
                      </div>
                    </div>

                    <div class="col-12 col-lg-2 d-none d-lg-block">
                      <div class="layout-post-sidebar">
                        <div class="layout-sidebar-item">
                          <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B3%A8%E8%A7%A3">1.生命周期注解</a>
<ul>
<li><a href="#1-entitylisteners">1. @EntityListeners</a></li>
<li><a href="#2-prepersist">2. @PrePersist</a></li>
<li><a href="#3-postpersist">3. @PostPersist</a></li>
<li><a href="#4-preupdate">4. @PreUpdate</a></li>
<li><a href="#5-postupdate">5. @PostUpdate</a></li>
<li><a href="#6-preremove">6. @PreRemove</a></li>
<li><a href="#7-postremove">7. @PostRemove</a></li>
<li><a href="#8-postload">8. @PostLoad</a></li>
<li><a href="#9-dynamicupdate">9. @DynamicUpdate</a></li>
<li><a href="#10-dynamicinsert">10. @DynamicInsert</a></li>
</ul>
</li>
<li><a href="#2-projections%E6%8A%95%E5%BD%B1">2. Projections（投影）</a>
<ul>
<li><a href="#%E6%8E%A5%E5%8F%A3%E6%8A%95%E5%BD%B1interface-projections">接口投影（Interface Projections）</a></li>
<li><a href="#closed-projections">（Closed Projections）</a></li>
<li><a href="#%E5%8A%A8%E6%80%81%E6%8A%95%E5%BD%B1-dynamic-projections">动态投影 (Dynamic Projections)</a></li>
<li><a href="#%E5%BC%80%E6%94%BE%E5%BC%8F%E6%8A%95%E5%BD%B1open-projections">开放式投影（open projections）</a></li>
</ul>
</li>
<li><a href="#3-%E8%A7%84%E8%8C%83specification">3. 规范（Specification）</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">基本使用</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E7%B1%BB">工具类</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="layout-totop d-none"><i class="fa fa-angle-up" aria-hidden="true"></i></div>

    	<div class="layout-footer">

		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">
					<div class="footer">
						<div class="row">
							<div class="col-12 col-md-9">
								<div class="footer-copy">
									
									<span>© 2018-05-01 </span>
									<a href="https://yz0812.github.io" title="yz">yz</a>
									<span class="px-2">⋅</span>
									
									
									<div class="footer-icp d-none d-sm-inline-block">
										<span class="px-2">⋅</span>
										
									</div>
								</div>
							</div>
							<div class="col-sm-3 d-none d-md-block">
								<div class="footer-links">
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script type="text/javascript" src='https://yz0812.github.io/media/scripts/main.js'></script>
	
	<script>
		var _hmt = _hmt || [];
		(function () {
			var hm = document.createElement("script");
			hm.src = "https://hm.baidu.com/hm.js?1bcfcef443c3da9720b8bc3f63856c73";
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(hm, s);
		})();
	</script>
	

  </div>
</body>

</html>